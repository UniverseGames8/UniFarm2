# Настройка и использование PostgreSQL на Replit

Это руководство описывает процесс настройки, миграции и использования PostgreSQL в среде Replit для проекта UniFarm.

## Содержание

1. [Создание базы данных на Replit](#1-создание-базы-данных-на-replit)
2. [Проверка подключения](#2-проверка-подключения)
3. [Миграция схемы базы данных](#3-миграция-схемы-базы-данных)
4. [Запуск приложения с базой данных Replit](#4-запуск-приложения-с-базой-данных-replit)
5. [Устранение неполадок](#5-устранение-неполадок)

## 1. Создание базы данных на Replit

### 1.1. Использование инструмента создания базы данных

Самый простой способ создать базу данных PostgreSQL на Replit - использовать встроенный инструмент:

```
create_postgresql_database_tool
```

Этот инструмент автоматически:
- Создаст базу данных PostgreSQL
- Настроит все необходимые переменные окружения
- Предоставит строку подключения (DATABASE_URL)

### 1.2. Проверка переменных окружения

После создания базы данных будут доступны следующие переменные окружения:

- `DATABASE_URL` - полная строка подключения к базе данных
- `PGHOST` - хост базы данных
- `PGPORT` - порт базы данных
- `PGUSER` - имя пользователя для подключения
- `PGPASSWORD` - пароль для подключения
- `PGDATABASE` - имя базы данных

Эти переменные должны быть автоматически добавлены в секреты Replit.

## 2. Проверка подключения

Для проверки успешного создания базы данных и настройки переменных окружения, выполните:

```bash
node check-replit-postgres.js
```

Этот скрипт:
- Проверит наличие необходимых переменных окружения
- Попробует подключиться к базе данных
- Выполнит тестовый запрос для проверки работоспособности
- Выведет информацию о существующих таблицах (если есть)

## 3. Миграция схемы базы данных

**ВАЖНО**: Перед миграцией откройте новый терминал, чтобы применить новые переменные окружения!

```bash
# Нажмите F1 и выберите "Shell: New Shell"
```

Для создания структуры базы данных используйте Drizzle ORM:

```bash
npx drizzle-kit push:pg
```

Или запустите скрипт миграции:

```bash
node migrate-replit-db.mjs
```

Эти команды:
- Проверят подключение к базе данных Replit
- Создадут таблицы на основе схемы из `shared/schema.ts`
- Выведут отчет о выполненной миграции

При необходимости изменить схему базы данных, отредактируйте файл `shared/schema.ts` и снова запустите миграцию.

## 4. Запуск приложения с базой данных Replit

Для запуска приложения с использованием базы данных Replit, выполните:

```bash
node start-with-replit-db.js
```

Или установите переменную окружения вручную и запустите сервер:

```bash
DATABASE_PROVIDER=replit npx tsx server/index.ts
```

## 5. Устранение неполадок

### Проблема: Переменные окружения не загружаются

**Решение**: Перезапустите терминал после создания базы данных:

```bash
# Нажмите клавишу F1
# Выберите "Shell: New Shell"
```

### Проблема: Ошибка подключения к базе данных

**Решение**: Проверьте корректность переменных окружения и доступность базы данных:

```bash
node check-replit-postgres.js
```

### Проблема: Ошибки миграции схемы

**Решение**: Проверьте файл схемы `shared/schema.ts` на наличие ошибок и несовместимостей с PostgreSQL.