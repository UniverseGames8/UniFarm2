# Руководство по использованию Neon DB в UniFarm

## Общая информация

UniFarm поддерживает работу с двумя базами данных PostgreSQL:

1. **Replit PostgreSQL** - для локальной разработки и тестирования
2. **Neon DB** - для продакшн окружения с высокой нагрузкой

Данное руководство описывает настройку и использование Neon DB в проекте.

## Преимущества Neon DB

- **Масштабируемость** - автоматическое масштабирование для обработки высоких нагрузок
- **Партиционирование** - поддержка партиционирования таблиц для оптимизации производительности
- **Выделенные ресурсы** - выделенные вычислительные ресурсы в отличие от shared ресурсов Replit
- **Connection Pooler** - встроенный пул соединений для оптимального управления подключениями
- **Отказоустойчивость** - автоматическое резервное копирование и высокая доступность
- **Мониторинг** - расширенные возможности для мониторинга производительности

## Настройка подключения

### 1. Файл конфигурации `.env.neon`

Для работы с Neon DB необходимо создать файл `.env.neon` со следующими параметрами:

```env
# Строка подключения к Neon DB
DATABASE_URL=postgresql://username:password@ep-example-id.region.aws.neon.tech/dbname?sslmode=require

# Принудительное использование Neon DB
FORCE_NEON_DB=true
DISABLE_REPLIT_DB=true
OVERRIDE_DB_PROVIDER=neon
DATABASE_PROVIDER=neon
USE_LOCAL_DB_ONLY=false

# Настройки для Telegram Bot и других сервисов
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
```

### 2. Запуск приложения с Neon DB

Для запуска приложения с настройками Neon DB используйте скрипт:

```bash
./start-with-neon.sh
```

Этот скрипт автоматически:
1. Загружает переменные окружения из `.env.neon`
2. Сбрасывает конфликтующие переменные
3. Устанавливает флаги для принудительного использования Neon DB
4. Запускает сервер с новыми настройками

## Партиционирование таблицы транзакций

Для оптимизации производительности реализовано партиционирование таблицы `transactions` по дате. Партиции создаются автоматически для каждого месяца.

### Проверка партиционирования

Для проверки статуса партиционирования запустите:

```bash
node create-transactions-partitions.cjs
```

### Создание новых партиций

Функция `create_future_transaction_partitions(months_ahead)` автоматически создает партиции на указанное количество месяцев вперед. 

```sql
-- Пример: создать партиции на 6 месяцев вперед
SELECT create_future_transaction_partitions(6);
```

## Переключение между базами данных

Приложение автоматически определяет, какую базу данных использовать, на основе переменных окружения. Принудительно использовать Neon DB можно с помощью параметра `FORCE_NEON_DB=true`.

## Мониторинг и диагностика

### Тестирование подключения

Для проверки подключения к Neon DB используйте:

```bash
node test-neon-connection.cjs
```

### Проверка конфигурации

Для проверки корректности настроек выполните:

```bash
node test-db-config.cjs
```

## Ограничения и особенности

1. **SSL-соединение** - Neon DB требует использования SSL для подключений, поэтому в строке подключения всегда должен быть параметр `?sslmode=require`
2. **Connection Pooler** - для высоконагруженных приложений рекомендуется использовать URL с суффиксом `-pooler` для подключения через Connection Pooler
3. **Партиционирование** - работает только для таблицы `transactions`, остальные таблицы используют стандартную структуру

## Устранение неполадок

### Проблема: Приложение продолжает использовать Replit PostgreSQL

**Решение**:
1. Убедитесь, что в `.env.neon` установлен параметр `FORCE_NEON_DB=true`
2. Проверьте, что строка подключения `DATABASE_URL` указывает на Neon DB
3. Запустите приложение через скрипт `./start-with-neon.sh`

### Проблема: Ошибка "Connection refused"

**Решение**:
1. Проверьте, что IP-адрес вашего сервера добавлен в список разрешенных в настройках Neon DB
2. Убедитесь, что параметр `sslmode=require` указан в строке подключения

### Проблема: Низкая производительность

**Решение**:
1. Используйте Connection Pooler (URL с суффиксом `-pooler`)
2. Проверьте партиционирование таблицы `transactions`
3. Настройте индексы для часто используемых запросов

## Дополнительные ресурсы

- [Документация Neon DB](https://neon.tech/docs/)
- [Партиционирование в PostgreSQL](https://www.postgresql.org/docs/current/ddl-partitioning.html)
- [Оптимизация запросов в PostgreSQL](https://www.postgresql.org/docs/current/performance-tips.html)