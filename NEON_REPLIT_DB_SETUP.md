# Настройка двойного режима баз данных: Neon DB и Replit PostgreSQL

Этот документ описывает настройку и использование двойного режима баз данных в проекте UniFarm - с возможностью переключения между Neon DB (для production) и Replit PostgreSQL (для development).

## Обзор архитектуры

Проект поддерживает два режима работы с базой данных:

1. **Режим Neon DB (Production)**
   - Использует Neon DB PostgreSQL, размещенную в облаке
   - Оптимизирован для высоких нагрузок и production-среды
   - Высокая доступность и масштабируемость
   - Требует настройки SSL-подключения (`sslmode=require`)
   - Конфигурация в файле `.env.neon`

2. **Режим Replit PostgreSQL (Development)**
   - Использует встроенную в Replit PostgreSQL базу данных
   - Оптимизирован для разработки и тестирования
   - Простота настройки (переменные окружения уже установлены)
   - Ограничения по размеру и нагрузкам
   - Конфигурация через переменные окружения Replit

## Выбор режима базы данных

Система использует несколько переменных окружения для определения, какая база данных должна использоваться:

1. **Приоритеты выбора БД:**
   - `FORCE_NEON_DB=true` → Принудительно использует Neon DB
   - `USE_LOCAL_DB_ONLY=true` → Принудительно использует Replit PostgreSQL
   - В режиме Production (`NODE_ENV=production`) → По умолчанию используется Neon DB
   - В режиме Development → По умолчанию используется Replit PostgreSQL

2. **Ключевые переменные окружения:**
   - `DATABASE_PROVIDER`: 'neon' или 'replit'
   - `FORCE_NEON_DB`: 'true' или 'false'
   - `DISABLE_REPLIT_DB`: 'true' или 'false'
   - `USE_LOCAL_DB_ONLY`: 'true' или 'false'
   - `NODE_ENV`: 'production' или 'development'

## Настройка Neon DB

1. **Создайте файл `.env.neon` с настройками подключения:**
   ```
   # Настройки принудительного использования Neon DB
   DATABASE_PROVIDER=neon
   USE_LOCAL_DB_ONLY=false
   DATABASE_URL=postgresql://username:password@endpoint.neon.tech/dbname?sslmode=require

   # Дополнительные настройки для предотвращения автоматического переключения
   FORCE_NEON_DB=true
   DISABLE_REPLIT_DB=true
   OVERRIDE_DB_PROVIDER=neon
   ```

2. **Проверьте подключение к Neon DB:**
   ```bash
   node check-neon-db.cjs
   ```

3. **Переключитесь на использование Neon DB:**
   ```bash
   ./db-switch.sh neon
   ```

## Настройка Replit PostgreSQL

1. **Переключитесь на использование Replit PostgreSQL:**
   ```bash
   ./db-switch.sh replit
   ```

2. **Проверьте подключение:**
   ```bash
   ./db-switch.sh status
   ```

## Инструменты для управления

В проекте есть несколько инструментов для работы с базами данных:

1. **`db-switch.sh`** - Скрипт для переключения между базами данных
   ```bash
   ./db-switch.sh             # Интерактивное меню
   ./db-switch.sh neon        # Переключение на Neon DB
   ./db-switch.sh replit      # Переключение на Replit PostgreSQL
   ./db-switch.sh status      # Проверка текущих настроек
   ```

2. **`check-neon-db.cjs`** - Проверка подключения к Neon DB
   ```bash
   node check-neon-db.cjs
   ```

3. **`fix-neon-partitions.cjs`** - Инструмент для работы с партициями в Neon DB
   ```bash
   node fix-neon-partitions.cjs
   ```

## Особенности и различия

### Neon DB:
- Требует настройки SSL (`sslmode=require`)
- Поддерживает партиционирование таблиц
- Имеет более высокую производительность для сложных запросов
- Требует внешнюю строку подключения (DATABASE_URL)
- Использует поле `operation` в таблице `partition_logs`

### Replit PostgreSQL:
- Автоматически настраивается в среде Replit
- Имеет ограничения по размеру и нагрузке
- Хорошо подходит для разработки и тестирования
- Использует локальное подключение на localhost

## Решение проблем

### Проблема: Приложение всегда использует Replit PostgreSQL

**Решение:**
1. Проверьте переменные окружения с помощью:
   ```bash
   ./db-switch.sh status
   ```
2. Убедитесь, что файл `.env.neon` корректно настроен
3. Используйте принудительное переключение:
   ```bash
   ./db-switch.sh neon
   ```
4. В случае проблем, запустите с прямым использованием Neon DB:
   ```bash
   node direct-neon-start.js
   ```

### Проблема: Ошибки подключения к Neon DB

**Решение:**
1. Проверьте, что в строке подключения есть параметр `sslmode=require`
2. Убедитесь, что учетные данные корректны
3. Проверьте сетевую доступность сервера Neon DB
4. Проверьте статус подключения:
   ```bash
   node check-neon-db.cjs
   ```

### Проблема: Ошибки с партиционированием

**Решение:**
1. Используйте инструмент для проверки и исправления партиций:
   ```bash
   node fix-neon-partitions.cjs
   ```
2. Выполните миграцию для создания партиционированной таблицы:
   ```bash
   node server/migrations/create_auto_partitioned_transactions.js
   ```

## Рекомендации по использованию

1. **Разработка:**
   - Используйте Replit PostgreSQL для повседневной разработки
   - Переключайтесь на Neon DB для тестирования production-функциональности

2. **Production:**
   - Всегда используйте Neon DB в production-окружении
   - Убедитесь, что партиционирование настроено правильно
   - Регулярно проверяйте состояние партиций для оптимальной производительности

3. **Миграции:**
   - При внесении изменений в структуру БД, проверяйте совместимость с обоими режимами
   - Тестируйте миграции сначала в Replit PostgreSQL, затем в Neon DB
   - Документируйте все изменения в схеме базы данных