/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ Replit
 * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç —Å—Ä–∞–∑—É, –∞ –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
 */

// –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞
process.env.NODE_ENV = 'development';

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏
const http = require('http');
const { exec, spawn } = require('child_process');

console.log('üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ UniFarm –¥–ª—è Replit...');

// –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ—Ä—Ç 5000 —Å –ø—Ä–æ—Å—Ç—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º, —á—Ç–æ–±—ã 
// Replit –ø–æ–Ω—è–ª, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
const tempServer = http.createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('Server starting, please wait...');
  
  // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ
  console.log(`–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å: ${req.method} ${req.url}`);
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 5000
tempServer.listen(5000, '0.0.0.0', () => {
  console.log('‚úÖ –ü–æ—Ä—Ç 5000 –æ—Ç–∫—Ä—ã—Ç, Replit —Å—á–∏—Ç–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–Ω—ã–º');
  
  // –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π —Å–µ—Ä–≤–µ—Ä
  console.log('üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...');
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º spawn, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å npm run dev
  const npmProcess = spawn('npm', ['run', 'dev'], {
    stdio: 'inherit',
    shell: false
  });
  
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
  npmProcess.on('error', (error) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ npm run dev:', error);
  });
  
  // –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞, –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π
  // –î–µ–ª–∞–µ–º —ç—Ç–æ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã Replit –Ω–µ —Å—á–∏—Ç–∞–ª, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª
  setTimeout(() => {
    tempServer.close(() => {
      console.log('‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∑–∞–∫—Ä—ã—Ç, –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç');
    });
  }, 5000); // 5 —Å–µ–∫—É–Ω–¥
});

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
process.on('SIGINT', () => {
  console.log('–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGINT, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...');
  tempServer.close();
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É...');
  tempServer.close();
  process.exit(0);
});