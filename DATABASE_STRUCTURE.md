# Структура базы данных UniFarm

## Обзор

База данных UniFarm использует PostgreSQL с Drizzle ORM для обеспечения высокой производительности и масштабируемости. Система оптимизирована для обработки большого объема транзакций и исторических данных.

## Таблицы

### users

Таблица с информацией о пользователях

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| username | VARCHAR(100) | Имя пользователя |
| telegram_id | VARCHAR(20) | Telegram ID пользователя |
| guest_id | VARCHAR(100) | ID гостя для доступа без авторизации |
| balance | NUMERIC(20, 9) | Баланс пользователя |
| ref_code | VARCHAR(8) | Реферальный код |
| ref_parent_id | INTEGER | ID пригласившего пользователя |
| created_at | TIMESTAMP | Дата создания аккаунта |
| updated_at | TIMESTAMP | Дата последнего обновления |
| wallet_address | VARCHAR(100) | Адрес кошелька TON |

### transactions

Партиционированная таблица для хранения всех транзакций

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | ID пользователя |
| amount | NUMERIC(20, 9) | Сумма транзакции |
| type | VARCHAR(50) | Тип транзакции |
| details | JSONB | Дополнительные данные |
| wallet_address | VARCHAR(100) | Адрес кошелька (для вывода) |
| created_at | TIMESTAMP | Дата создания |

**Примечание:** Таблица `transactions` партиционирована по дате (RANGE) с ежедневными партициями в формате `transactions_YYYY_MM_DD`. Каждая партиция имеет индексы для оптимизации запросов.

### uni_farming_deposits

Хранит информацию о депозитах в UNI-фарминг

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | ID пользователя |
| amount | NUMERIC(20, 9) | Сумма депозита |
| rate | NUMERIC(20, 18) | Скорость начисления в секунду |
| active | BOOLEAN | Активность депозита |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата последнего обновления |

### ton_boost_deposits

Депозиты для усиления доходности от TON

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | ID пользователя |
| amount | NUMERIC(20, 9) | Сумма депозита в TON |
| boost_percent | NUMERIC(5, 2) | Процент усиления доходности |
| active | BOOLEAN | Активность депозита |
| created_at | TIMESTAMP | Дата создания |
| duration_days | INTEGER | Длительность в днях |
| expires_at | TIMESTAMP | Дата окончания |

### referrals

Таблица для хранения структуры реферальной системы

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | ID пользователя |
| parent_id | INTEGER | ID пригласившего пользователя |
| level | INTEGER | Уровень в реферальной структуре |
| created_at | TIMESTAMP | Дата создания |

### missions

Задания для пользователей

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| name | VARCHAR(100) | Название задания |
| description | TEXT | Описание задания |
| reward | NUMERIC(20, 9) | Награда за выполнение |
| type | VARCHAR(50) | Тип задания |
| active | BOOLEAN | Активность задания |
| requirements | JSONB | Требования для выполнения |

### user_missions

Связь между пользователями и заданиями

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | ID пользователя |
| mission_id | INTEGER | ID задания |
| completed | BOOLEAN | Статус выполнения |
| progress | JSONB | Прогресс выполнения |
| completed_at | TIMESTAMP | Дата выполнения |

### farming_deposits

Таблица для хранения всех депозитов в фарминг (альтернативный подход)

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | ID пользователя |
| amount | NUMERIC(20, 9) | Сумма депозита |
| type | VARCHAR(50) | Тип фарминга |
| rate | NUMERIC(20, 18) | Скорость начисления |
| active | BOOLEAN | Активность депозита |
| created_at | TIMESTAMP | Дата создания |
| updated_at | TIMESTAMP | Дата последнего обновления |
| details | JSONB | Дополнительная информация |

### farming_snapshots

Таблица для хранения ежедневных снимков состояния фарминга

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | ID пользователя |
| total_farming | NUMERIC(20, 9) | Общий объем средств в фарминге |
| total_earned | NUMERIC(20, 9) | Общее количество заработанных средств |
| active_deposits | INTEGER | Количество активных депозитов |
| snapshot_date | DATE | Дата снимка |
| created_at | TIMESTAMP | Дата создания записи |

### wallet_snapshots

Таблица для хранения ежедневных снимков балансов кошельков

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| user_id | INTEGER | ID пользователя |
| balance | NUMERIC(20, 9) | Баланс на момент снимка |
| wallet_address | VARCHAR(100) | Адрес кошелька |
| snapshot_date | DATE | Дата снимка |
| created_at | TIMESTAMP | Дата создания записи |

### admin_logs

Таблица для отслеживания действий администраторов

| Поле | Тип | Описание |
|------|-----|----------|
| id | SERIAL | Первичный ключ |
| admin_id | INTEGER | ID администратора |
| action | VARCHAR(100) | Выполненное действие |
| target_table | VARCHAR(50) | Целевая таблица |
| target_id | INTEGER | ID затронутой записи |
| before_state | JSONB | Состояние до изменения |
| after_state | JSONB | Состояние после изменения |
| created_at | TIMESTAMP | Дата действия |
| ip_address | VARCHAR(50) | IP-адрес |
| user_agent | TEXT | User-Agent администратора |

## Индексы

### Индексы для таблицы transactions

Каждая партиция таблицы `transactions` имеет следующие индексы:
- `transactions_YYYY_MM_DD_user_id_idx` - по полю `user_id`
- `transactions_YYYY_MM_DD_type_idx` - по полю `type`
- `transactions_YYYY_MM_DD_created_at_idx` - по полю `created_at`

### Индексы для uni_farming_deposits
- `idx_uni_farming_deposits_user_id` - по полю `user_id`
- `idx_uni_farming_deposits_active` - по полю `active`
- `idx_uni_farming_deposits_user_active` - составной по `user_id` и `active`

### Индексы для referrals
- `idx_referrals_user_id` - по полю `user_id`
- `idx_referrals_parent_id` - по полю `parent_id`
- `idx_referrals_level` - по полю `level`
- `idx_referrals_user_parent` - составной по `user_id` и `parent_id`

## Партиционирование

Таблица `transactions` использует партиционирование по диапазону дат (RANGE partitioning). Это позволяет:

1. Улучшить производительность запросов за счет секционирования данных
2. Упростить архивацию и удаление старых данных
3. Оптимизировать операции обслуживания (индексирование, очистка)

### Схема партиционирования

- Основная таблица: `transactions`
- Партиции: `transactions_YYYY_MM_DD` для каждого дня
- Каждая партиция содержит данные за один день
- Партиции автоматически создаются для нескольких дней вперед
- Партиции старше 7 дней могут быть удалены после создания снимков

### Автоматическое управление партициями

Система включает автоматизированные скрипты для:
1. Создания новых партиций на 30 дней вперед
2. Создания ежедневных снимков данных фарминга (farming_snapshots)
3. Создания ежедневных снимков балансов пользователей (wallet_snapshots)
4. Безопасного удаления партиций старше 7 дней при наличии снимков

## Принципы безопасности данных

1. Перед удалением партиций создаются ежедневные снимки ключевых данных
2. Все операции с партициями имеют резервное копирование и проверку целостности
3. Удаление партиций выполняется только при наличии валидных снимков
4. Система поддерживает восстановление в случае сбоя операций партиционирования

## Управление данными

Для управления большими объемами данных используются следующие стратегии:
1. Ежедневное партиционирование транзакций
2. Создание агрегированных снимков для долгосрочного хранения статистики
3. Удаление старых детальных данных с сохранением агрегированной информации
4. Оптимизированные индексы для часто используемых запросов