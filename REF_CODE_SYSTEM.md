# Система реферальных кодов UniFarm

## Введение

Реферальная система UniFarm основана на уникальных реферальных кодах (`ref_code`), которые автоматически генерируются для каждого пользователя. Эти коды используются для создания реферальных ссылок и отслеживания рефералов в многоуровневой партнерской программе.

## Принципы работы

1. **Автоматическая генерация**: Каждый пользователь получает уникальный реферальный код при регистрации
2. **Уникальность**: Система гарантирует уникальность каждого кода через проверки в базе данных
3. **Доступность**: Реферальный код доступен как пользователям с telegram_id, так и в режиме AirDrop (по guest_id)
4. **Проактивная генерация**: Код генерируется на сервере при создании пользователя и проверяется при получении данных

## Процесс генерации кодов

Система использует несколько уровней проверки для обеспечения наличия реферального кода:

1. При создании пользователя в `UserService.createUser()` (проактивная генерация)
2. При восстановлении сессии в `SessionController.restoreSession()` (проверка и генерация)
3. При запросе данных пользователя в `UserController.getCurrentUser()` (проверка и генерация)
4. Через специальный API-эндпоинт `/api/users/generate-refcode` (по запросу с клиента)

## API эндпоинты для работы с реферальными кодами

- `GET /api/me` - получение данных пользователя, включая реферальный код
- `POST /api/users/generate-refcode` - генерация нового реферального кода (принимает `user_id` или `guest_id`)

## Обслуживание системы

### Скрипт для обновления пользователей без реферальных кодов

Если у пользователей отсутствуют реферальные коды, можно запустить миграционный скрипт:

```bash
node update-missing-refcodes.js
```

Этот скрипт:
1. Находит всех пользователей без реферальных кодов
2. Генерирует для каждого уникальный код
3. Обновляет записи в базе данных
4. Выводит статистику по обновленным пользователям

### Рекомендации по поддержке

- Запускайте скрипт миграции после обновления кода
- Мониторьте логи на предмет сообщений об отсутствии реферальных кодов
- Регулярно проверяйте базу данных на наличие пользователей без кодов

## Устранение неполадок

### Проблема: Пользователь не видит реферальную ссылку

Возможные причины:
1. Отсутствие ref_code в базе данных
2. Устаревшие данные в кэше React Query
3. Ошибка в процессе генерации кода

Решения:
1. Проверьте таблицу `users` на наличие ref_code для пользователя
2. Обновите кэш на клиенте через компонент `UniFarmReferralLink`
3. Запустите миграционный скрипт `update-missing-refcodes.js`

## Схема процесса генерации реферальных кодов

```
Создание пользователя
       │
       ▼
┌─────────────┐     ┌─────────────────────┐
│Проверка на  │ нет │Генерация уникального│
│наличие кода ├────►│ ref_code            │
└─────┬───────┘     └───────────┬─────────┘
      │ да                      │
      ▼                         │
┌─────────────┐                 │
│Проверка     │                 │
│уникальности ├─────────────────┘
│             │ не уникален
└─────┬───────┘
      │ уникален
      ▼
┌─────────────┐
│Сохранение   │
│пользователя │
└─────────────┘
```

## Технические детали

Реферальные коды:
- Длина: 8 символов
- Символы: a-z, 2-9 (исключены символы, которые могут быть неоднозначно восприняты: 0, O, 1, I, l)
- Алгоритм: криптографически стойкая генерация через `crypto.randomBytes()`
- Хранение: в поле `ref_code` таблицы `users`