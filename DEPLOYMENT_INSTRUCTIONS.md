# Инструкции по деплою UniFarm на Replit

## Предварительная подготовка

1. Убедитесь, что у вас есть токен Telegram бота в переменных окружения: 
   - `TELEGRAM_BOT_TOKEN` 

2. Сконфигурирована база данных Replit PostgreSQL с переменными окружения:
   - `DATABASE_URL=postgresql://runner@localhost:5432/postgres`
   - `PGDATABASE=postgres` 
   - `PGUSER=runner`
   - `PGHOST=localhost` 
   - `PGPORT=5432`

## Процесс деплоя

### 1. Подготовка конфигурационного файла

Создайте или обновите файл `.replit` в корне проекта, скопировав содержимое из `.replit.production`:

```bash
cp .replit.production .replit
```

### 2. Проверка конфигурации

Убедитесь, что в `.replit` указаны правильные параметры:
- `PORT=3000` 
- `DATABASE_PROVIDER=replit`
- `NODE_ENV=production`

### 3. Запуск сборки

Соберите проект, выполнив команду:

```bash
npm run build
```

### 4. Запуск миграций базы данных

Выполните миграции для создания таблиц в базе данных:

```bash
NODE_ENV=production DATABASE_PROVIDER=replit npm run db:push
```

### 5. Запуск сервера

Запустите сервер в production режиме:

```bash
NODE_ENV=production PORT=3000 DATABASE_PROVIDER=replit node start-unified.js
```

### 6. Дополнительные проверки

#### Проверка базы данных

Убедитесь, что соединение с базой данных работает корректно:

```bash
node check-replit-db.js
```

#### Проверка Telegram бота

Убедитесь, что бот правильно сконфигурирован для мини-приложения:

```bash
node check-bot-settings.js
```

## Решение проблем

### Белый экран после деплоя

1. Проверьте логи сервера на наличие ошибок
2. Убедитесь, что сервер запущен на правильном порту (3000)
3. Проверьте соединение с базой данных

### Проблемы с ESM/CommonJS модулями

В проекте используется гибридный подход:
- `package.json` настроен на использование ESM (`"type": "module"`)
- Сервер запускается через start-unified.js (CommonJS)
- Production-сервер использует ESM синтаксис (production-server.mjs)

### Проблемы с базой данных

Если возникают ошибки подключения к базе:
1. Убедитесь, что база данных создана в Replit
2. Проверьте, что переменные окружения настроены правильно
3. Выполните команду миграции заново

## Контакты

При возникновении вопросов обращайтесь к команде разработки UniFarm.