# Комплексный аудит цепочки API → Контроллер → БД UniFarm

## Цель аудита

Проведение полного анализа цепочки обработки запросов в приложении UniFarm:
API → Контроллер → База данных

Аудит направлен на выявление любых рассогласований, ошибок и слабых мест в логике, валидации, 
записи данных и возврате ответов клиенту.

## Методология

Для аудита была разработана специальная методология, включающая:

1. **Автоматизированное тестирование** ключевых API-эндпоинтов
2. **Анализ кода контроллеров** на предмет соответствия стандартам
3. **Проверка согласованности** между параметрами запросов и операциями в БД
4. **Валидация ответов API** на соответствие единому формату
5. **Сквозное тестирование** цепочек действий от пользователя до базы данных

## Результаты анализа API-эндпоинтов

### 1. Аутентификация и регистрация

| API Endpoint           | Контроллер          | Операции с БД                     | Проблемы/Недостатки |
|------------------------|--------------------|----------------------------------|----------------------|
| `/auth/register-guest` | authController     | - INSERT в таблицу users<br>- Генерация уникального ref_code<br>- Установка начального баланса | - Отсутствие проверки на существование guest_id<br>- Нет возвращения ошибки при дублировании guest_id |
| `/auth/register`       | authController     | - INSERT в таблицу auth_users<br>- INSERT в таблицу users | - Нет валидации сложности пароля<br>- Слабая валидация username |
| `/auth/login`          | authController     | - SELECT из auth_users<br>- Проверка пароля<br>- Создание сессии | - Нет защиты от брутфорса<br>- Отсутствие логирования неудачных попыток |
| `/auth/test-referral`  | authController     | - SELECT из users по ref_code | - Тестовый эндпоинт доступен в production |

### 2. Управление фармингом

| API Endpoint              | Контроллер            | Операции с БД                     | Проблемы/Недостатки |
|---------------------------|----------------------|----------------------------------|----------------------|
| `/uni-farming/deposit`    | uniFarmingController | - UPDATE users.balance_uni<br>- INSERT uni_farming_deposits<br>- INSERT transactions | - Отсутствие проверки отрицательных сумм<br>- Недостаточная валидация user_id<br>- Нет транзакционности |
| `/uni-farming/harvest`    | uniFarmingController | - Расчет накопленного вознаграждения<br>- UPDATE users.balance_uni<br>- INSERT transactions | - Слабая проверка на существование пользователя<br>- Возможно начисление нулевого вознаграждения<br>- Отсутствие проверки на активные депозиты |
| `/uni-farming/deposits`   | uniFarmingController | - SELECT из uni_farming_deposits<br>- JOIN с users | - Нестандартный формат ответа<br>- Отсутствие пагинации для большого количества депозитов |

### 3. Транзакции и балансы

| API Endpoint    | Контроллер           | Операции с БД                     | Проблемы/Недостатки |
|-----------------|---------------------|----------------------------------|----------------------|
| `/withdraw`     | transactionController | - Проверка баланса<br>- INSERT в transactions со статусом 'pending' | - Неполная валидация адреса кошелька<br>- Недостаточная проверка типа и значения amount<br>- Баланс не обновляется непосредственно, только создается запись |
| `/transactions` | transactionController | - SELECT из transactions<br>- Фильтрация по user_id | - Непоследовательная обработка пользовательского ввода<br>- Неоптимальные запросы без пагинации<br>- Отсутствие фильтрации по типу или статусу |

### 4. Реферальная система

| API Endpoint        | Контроллер          | Операции с БД                     | Проблемы/Недостатки |
|---------------------|--------------------|----------------------------------|----------------------|
| `/referral/tree`    | referralController | - SELECT из referrals с JOIN users<br>- Формирование иерархической структуры | - Непоследовательный формат ответа<br>- Отсутствие проверки на существование user_id<br>- Возможна циклическая рекурсия при неправильных данных |
| `/referral/stats`   | referralController | - SELECT из referrals<br>- Агрегация для подсчета статистики | - Недостаточная валидация входных параметров<br>- Нет обработки случаев с некорректными данными |
| `/referral/link`    | referralController | - SELECT из users по ref_code<br>- Генерация персональной ссылки | - Дублирование кода проверки валидности ref_code<br>- Нестандартизированный формат ответа |

### 5. Управление кошельком

| API Endpoint            | Контроллер        | Операции с БД                     | Проблемы/Недостатки |
|-------------------------|------------------|----------------------------------|----------------------|
| `/wallet/link-address`  | walletController | - SELECT из users для проверки<br>- UPDATE ton_wallet_address | - Слабая валидация формата TON-адреса<br>- Непоследовательная проверка существования пользователя |
| `/wallet/address`       | walletController | - SELECT из users по user_id | - Отсутствие стандартизации ответа<br>- Нет обработки для отсутствующего адреса |

## Выявленные комплексные проблемы

### 1. Проблемы валидации

- **Неконсистентная валидация пользовательского ввода**
  - Разные контроллеры используют разные подходы к валидации параметров
  - Отсутствие централизованного механизма валидации (middleware)
  - Нестандартизированные сообщения об ошибках

- **Недостаточная проверка существования ресурсов**
  - Многие контроллеры не проверяют наличие пользователя перед операциями
  - Отсутствие проверки на наличие депозитов при операциях с ними

- **Небезопасное преобразование типов**
  - Неявное преобразование строк в числа без проверки на NaN
  - Отсутствие проверки на отрицательные значения для сумм
  - Смешение строковых и числовых типов для денежных величин

### 2. Проблемы работы с базой данных

- **Отсутствие транзакционности**
  - Критические операции не обернуты в транзакции
  - Возможны несогласованные состояния при сбоях

- **Неэффективные запросы**
  - Отсутствие пагинации для потенциально больших наборов данных
  - Избыточные запросы к БД вместо объединения логически связанных операций

- **Проблемы структуры данных**
  - Несоответствие между типами в схеме БД и кодом контроллеров
  - Неконсистентное использование NULL vs пустые строки

### 3. Проблемы API-ответов

- **Нестандартизированные форматы ответов**
  - Разные контроллеры возвращают разную структуру ответа
  - Непоследовательное использование ключей success/data/error

- **Неоптимальные HTTP-коды ответов**
  - Использование 200 OK даже при логических ошибках
  - Некорректное использование кодов 4xx

- **Отсутствие детальной информации об ошибках**
  - Сообщения об ошибках слишком общие
  - Нет указания на конкретное поле с ошибкой

## Рекомендации по исправлению

### Рекомендации по архитектуре

1. **Стандартизация API-ответов**
   - Создать middleware для единообразной обработки и форматирования ответов
   - Внедрить единый формат ответа: `{ success: boolean, data: Object, error?: Object }`
   - Стандартизировать коды HTTP-ответов в соответствии с типом ошибки

2. **Централизованная валидация**
   - Разработать общий валидатор с использованием Zod или аналогичной библиотеки
   - Внедрить middleware для валидации запросов перед передачей их контроллерам
   - Стандартизировать сообщения об ошибках валидации

3. **Улучшение работы с БД**
   - Использовать транзакции для всех многоэтапных операций
   - Внедрить сервисный слой для доступа к данным с встроенной валидацией
   - Разработать механизм идемпотентных запросов для предотвращения дубликатов

### Конкретные исправления по контроллерам

#### AuthController
- Добавить проверку сложности пароля
- Внедрить защиту от брутфорса и блокировку IP после нескольких неудачных попыток
- Добавить проверку уникальности guest_id перед созданием пользователя

#### UniFarmingController
- Добавить транзакционность для операций депозита и сбора
- Внедрить проверку положительных значений для всех сумм
- Улучшить проверку существования пользователя
- Добавить проверку на активные депозиты перед сбором урожая

#### TransactionController
- Улучшить валидацию адреса кошелька
- Стандартизировать операции с балансом через сервис
- Добавить пагинацию для списка транзакций
- Внедрить дополнительные фильтры для запросов

#### ReferralController
- Добавить защиту от циклических зависимостей в дереве рефералов
- Улучшить валидацию ref_code
- Стандартизировать формат ответа API

#### WalletController
- Усилить валидацию TON-адреса
- Добавить проверку на существование пользователя
- Стандартизировать обработку ошибок

## Заключение

Анализ API-цепочки UniFarm выявил несколько проблемных областей, требующих внимания:

1. **Валидация параметров**: необходима стандартизация и усиление валидации во всех контроллерах
2. **Работа с БД**: требуется внедрение транзакционности и оптимизация запросов
3. **Формат ответов API**: необходима унификация структуры ответов всех API-эндпоинтов
4. **Согласованность типов**: требуется унификация работы с числовыми типами для финансовых операций

Реализация предложенных рекомендаций позволит значительно улучшить надежность, безопасность 
и поддерживаемость системы.